<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ShopSmart AI | Product</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
  :root{
    --ink:#0f0e17;--paper:#fffcf5;--gold:#c9a84c;--cream:#f5f0e8;
    --muted:#8a8278;--card:#ffffff;--radius:16px;--error:#c0392b;
  }
  html,body{font-family:'DM Sans',sans-serif;background:var(--paper);color:var(--ink)}
  body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");pointer-events:none;z-index:999}

  /* NAV */
  nav{position:sticky;top:0;z-index:100;padding:16px 48px;display:flex;align-items:center;justify-content:space-between;background:rgba(255,252,245,.9);backdrop-filter:blur(16px);border-bottom:1px solid rgba(201,168,76,.15)}
  .nav-brand{font-family:'Playfair Display',serif;font-size:1.3rem;font-weight:700;display:flex;align-items:center;gap:10px;cursor:pointer}
  .brand-dot{width:8px;height:8px;background:var(--gold);border-radius:50%;animation:pulse 2s ease-in-out infinite}
  @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.5);opacity:.6}}
  .nav-btn{padding:9px 20px;border:none;border-radius:100px;font-family:'DM Sans',sans-serif;font-size:.875rem;font-weight:500;cursor:pointer;transition:all .25s cubic-bezier(.34,1.56,.64,1);margin-left:8px}
  .nav-btn.ghost{background:transparent;color:var(--muted);border:1.5px solid rgba(138,130,120,.3)}
  .nav-btn.ghost:hover{background:var(--cream);border-color:var(--gold);color:var(--ink);transform:translateY(-1px)}
  .nav-btn.primary{background:var(--ink);color:var(--paper)}
  .nav-btn.primary:hover{background:var(--gold);color:var(--ink);transform:translateY(-1px)}

  /* BREADCRUMB */
  .breadcrumb{max-width:1200px;margin:24px auto 0;padding:0 48px;font-size:.82rem;color:var(--muted);display:flex;align-items:center;gap:8px}
  .breadcrumb a{color:var(--muted);text-decoration:none;transition:color .2s}
  .breadcrumb a:hover{color:var(--gold)}
  .breadcrumb span{color:var(--gold)}

  /* PRODUCT HERO */
  .product-hero{max-width:1200px;margin:24px auto 0;padding:0 48px;display:grid;grid-template-columns:1fr 1fr;gap:56px;align-items:start}
  
  /* IMAGE */
  .img-wrap{position:relative;border-radius:24px;overflow:hidden;background:var(--cream);aspect-ratio:1;box-shadow:0 20px 60px rgba(15,14,23,.1)}
  .img-wrap img{width:100%;height:100%;object-fit:cover;transition:transform .5s ease}
  .img-wrap:hover img{transform:scale(1.04)}
  .img-badge{position:absolute;top:20px;left:20px;padding:6px 14px;background:var(--ink);color:var(--paper);border-radius:100px;font-size:.72rem;font-weight:500;letter-spacing:.08em;text-transform:uppercase}

  /* PRODUCT INFO */
  .product-info{padding-top:8px}
  .info-cat{font-size:.72rem;letter-spacing:.18em;text-transform:uppercase;color:var(--gold);font-weight:500;margin-bottom:12px}
  .info-name{font-family:'Playfair Display',serif;font-size:clamp(1.8rem,3vw,2.6rem);font-weight:700;letter-spacing:-1px;line-height:1.1;margin-bottom:16px}
  
  /* RATING DISPLAY */
  .rating-row{display:flex;align-items:center;gap:12px;margin-bottom:20px}
  .stars{display:flex;gap:2px}
  .star{font-size:1.1rem;color:#d4c5a9;transition:color .2s}
  .star.filled{color:var(--gold)}
  .star.half{position:relative;color:#d4c5a9}
  .star.half::before{content:'‚òÖ';position:absolute;left:0;color:var(--gold);width:50%;overflow:hidden}
  .rating-num{font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:700;color:var(--ink)}
  .rating-count{font-size:.82rem;color:var(--muted)}

  .info-desc{font-size:.95rem;color:var(--muted);font-weight:300;line-height:1.8;margin-bottom:28px;max-width:420px}
  .info-price{font-family:'Playfair Display',serif;font-size:2.4rem;font-weight:700;color:var(--ink);margin-bottom:28px;letter-spacing:-1px}
  .info-price .currency{font-size:1.4rem;vertical-align:super;margin-right:2px}

  /* ADD TO CART */
  .cart-row{display:flex;gap:12px;align-items:center;margin-bottom:32px}
  .qty-wrap{display:flex;align-items:center;gap:0;background:var(--cream);border-radius:100px;border:1.5px solid rgba(201,168,76,.2);overflow:hidden}
  .qty-btn{width:40px;height:44px;border:none;background:transparent;font-size:1.1rem;cursor:pointer;color:var(--ink);transition:background .2s}
  .qty-btn:hover{background:rgba(201,168,76,.15)}
  .qty-num{width:36px;text-align:center;font-weight:500;font-size:.95rem}
  .add-cart-btn{flex:1;padding:13px 28px;background:var(--ink);color:var(--paper);border:none;border-radius:100px;font-family:'DM Sans',sans-serif;font-size:1rem;font-weight:500;cursor:pointer;transition:all .3s cubic-bezier(.34,1.56,.64,1);display:flex;align-items:center;justify-content:center;gap:8px}
  .add-cart-btn:hover{background:var(--gold);color:var(--ink);transform:translateY(-2px);box-shadow:0 10px 28px rgba(201,168,76,.35)}
  .add-cart-btn.added{background:var(--gold);color:var(--ink)}
  .wishlist-btn2{width:48px;height:48px;border-radius:50%;border:1.5px solid rgba(201,168,76,.3);background:transparent;font-size:1.2rem;cursor:pointer;transition:all .2s cubic-bezier(.34,1.56,.64,1)}
  .wishlist-btn2:hover,.wishlist-btn2.saved{background:rgba(201,168,76,.1);border-color:var(--gold);transform:scale(1.1)}

  /* TAGS */
  .info-tags{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:24px}
  .tag{padding:6px 14px;background:var(--cream);border:1px solid rgba(201,168,76,.2);border-radius:100px;font-size:.78rem;color:var(--muted)}

  /* DIVIDER */
  .divider-line{height:1px;background:rgba(201,168,76,.15);margin:32px 0}

  /* REVIEWS SECTION */
  .reviews-section{max-width:1200px;margin:48px auto;padding:0 48px 80px}
  .section-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:32px;flex-wrap:wrap;gap:16px}
  .section-title{font-family:'Playfair Display',serif;font-size:1.6rem;font-weight:700;letter-spacing:-.5px;display:flex;align-items:center;gap:12px}
  .section-title::before{content:'';width:28px;height:2px;background:var(--gold)}

  /* RATING SUMMARY */
  .rating-summary{display:grid;grid-template-columns:auto 1fr;gap:32px;background:var(--card);border:1px solid rgba(201,168,76,.12);border-radius:var(--radius);padding:28px;margin-bottom:32px;box-shadow:0 2px 12px rgba(15,14,23,.04)}
  .big-score{text-align:center;padding-right:32px;border-right:1px solid rgba(201,168,76,.15)}
  .big-num{font-family:'Playfair Display',serif;font-size:3.5rem;font-weight:700;color:var(--ink);line-height:1}
  .big-stars{display:flex;gap:3px;justify-content:center;margin:8px 0 4px}
  .big-stars .star{font-size:1.3rem}
  .big-count{font-size:.78rem;color:var(--muted)}
  .bars{display:flex;flex-direction:column;gap:8px;justify-content:center}
  .bar-row{display:flex;align-items:center;gap:10px;font-size:.82rem}
  .bar-label{width:24px;text-align:right;color:var(--muted);font-weight:500}
  .bar-track{flex:1;height:6px;background:var(--cream);border-radius:100px;overflow:hidden}
  .bar-fill{height:100%;background:var(--gold);border-radius:100px;transition:width .6s ease}
  .bar-count{width:28px;color:var(--muted);font-size:.78rem}

  /* WRITE REVIEW */
  .write-review{background:var(--card);border:1px solid rgba(201,168,76,.12);border-radius:var(--radius);padding:28px;margin-bottom:32px;box-shadow:0 2px 12px rgba(15,14,23,.04)}
  .wr-title{font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:700;margin-bottom:20px}
  .star-picker{display:flex;gap:6px;margin-bottom:16px}
  .star-pick{font-size:1.8rem;cursor:pointer;color:#d4c5a9;transition:all .15s cubic-bezier(.34,1.56,.64,1)}
  .star-pick:hover,.star-pick.active{color:var(--gold);transform:scale(1.2)}
  .review-input{width:100%;padding:13px 16px;font-family:'DM Sans',sans-serif;font-size:.9rem;border:1.5px solid rgba(138,130,120,.2);border-radius:12px;background:white;color:var(--ink);outline:none;resize:vertical;min-height:90px;transition:all .2s}
  .review-input:focus{border-color:var(--gold);box-shadow:0 0 0 4px rgba(201,168,76,.1)}
  .submit-review{margin-top:12px;padding:11px 28px;background:var(--ink);color:var(--paper);border:none;border-radius:100px;font-family:'DM Sans',sans-serif;font-size:.9rem;font-weight:500;cursor:pointer;transition:all .3s cubic-bezier(.34,1.56,.64,1)}
  .submit-review:hover{background:var(--gold);color:var(--ink);transform:translateY(-1px)}
  .review-msg{margin-top:10px;font-size:.85rem;padding:8px 14px;border-radius:10px;display:none}
  .review-msg.success{background:rgba(39,174,96,.1);color:#27ae60;display:block}
  .review-msg.error{background:rgba(192,57,43,.08);color:var(--error);display:block}
  .login-prompt{font-size:.88rem;color:var(--muted);padding:12px 0}
  .login-prompt a{color:var(--gold);cursor:pointer;font-weight:500}

  /* REVIEW CARDS */
  .reviews-list{display:flex;flex-direction:column;gap:16px}
  .review-card{background:var(--card);border:1px solid rgba(201,168,76,.1);border-radius:var(--radius);padding:22px;box-shadow:0 2px 8px rgba(15,14,23,.04);animation:slideUp .4s ease-out}
  @keyframes slideUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
  .rv-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .rv-user{font-weight:500;font-size:.9rem}
  .rv-date{font-size:.78rem;color:var(--muted)}
  .rv-stars{display:flex;gap:2px;margin-bottom:8px}
  .rv-stars .star{font-size:.9rem}
  .rv-text{font-size:.88rem;color:var(--muted);line-height:1.6;font-weight:300}
  .no-reviews{text-align:center;padding:40px;color:var(--muted);font-size:.9rem}

  /* SIMILAR PRODUCTS */
  .similar-section{max-width:1200px;margin:0 auto;padding:0 48px 80px}
  .similar-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:20px;margin-top:24px}
  .sim-card{background:var(--card);border:1px solid rgba(201,168,76,.1);border-radius:var(--radius);overflow:hidden;cursor:pointer;transition:all .3s ease;box-shadow:0 2px 12px rgba(15,14,23,.04)}
  .sim-card:hover{transform:translateY(-5px);border-color:rgba(201,168,76,.4);box-shadow:0 16px 40px rgba(15,14,23,.1)}
  .sim-img{height:160px;overflow:hidden;background:var(--cream)}
  .sim-img img{width:100%;height:100%;object-fit:cover;transition:transform .4s ease}
  .sim-card:hover .sim-img img{transform:scale(1.08)}
  .sim-body{padding:16px}
  .sim-cat{font-size:.7rem;letter-spacing:.12em;text-transform:uppercase;color:var(--gold);margin-bottom:4px}
  .sim-name{font-family:'Playfair Display',serif;font-size:.95rem;font-weight:700;margin-bottom:6px;line-height:1.3}
  .sim-price{font-family:'Playfair Display',serif;font-size:1rem;font-weight:700;color:var(--ink)}

  /* CART SIDEBAR */
  .cart-overlay{position:fixed;inset:0;background:rgba(15,14,23,.5);z-index:200;opacity:0;pointer-events:none;transition:opacity .3s;backdrop-filter:blur(4px)}
  .cart-overlay.open{opacity:1;pointer-events:all}
  .cart-drawer{position:fixed;right:0;top:0;bottom:0;width:420px;background:var(--paper);z-index:201;transform:translateX(100%);transition:transform .35s cubic-bezier(.4,0,.2,1);display:flex;flex-direction:column;box-shadow:-20px 0 60px rgba(15,14,23,.15)}
  .cart-drawer.open{transform:translateX(0)}
  .cart-head{padding:24px 28px;border-bottom:1px solid rgba(201,168,76,.15);display:flex;align-items:center;justify-content:space-between}
  .cart-title{font-family:'Playfair Display',serif;font-size:1.3rem;font-weight:700}
  .cart-close{width:36px;height:36px;border:none;background:var(--cream);border-radius:50%;cursor:pointer;font-size:1.1rem;display:flex;align-items:center;justify-content:center;transition:all .2s}
  .cart-close:hover{background:var(--gold);color:var(--ink)}
  .cart-items{flex:1;overflow-y:auto;padding:20px 28px}
  .cart-item{display:flex;gap:14px;padding:14px 0;border-bottom:1px solid rgba(201,168,76,.1)}
  .ci-img{width:64px;height:64px;border-radius:10px;overflow:hidden;background:var(--cream);flex-shrink:0}
  .ci-img img{width:100%;height:100%;object-fit:cover}
  .ci-info{flex:1}
  .ci-name{font-size:.88rem;font-weight:500;margin-bottom:4px}
  .ci-price{font-family:'Playfair Display',serif;font-size:.95rem;font-weight:700;color:var(--ink)}
  .ci-qty{font-size:.78rem;color:var(--muted);margin-top:2px}
  .ci-remove{background:none;border:none;cursor:pointer;color:var(--muted);font-size:1rem;transition:color .2s;align-self:flex-start;padding:2px}
  .ci-remove:hover{color:var(--error)}
  .cart-empty{text-align:center;padding:60px 20px;color:var(--muted)}
  .cart-empty-icon{font-size:2.5rem;margin-bottom:12px}
  .cart-footer{padding:20px 28px;border-top:1px solid rgba(201,168,76,.15)}
  .cart-total{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
  .ct-label{font-size:.88rem;color:var(--muted)}
  .ct-amount{font-family:'Playfair Display',serif;font-size:1.4rem;font-weight:700}
  .checkout-btn{width:100%;padding:14px;background:var(--ink);color:var(--paper);border:none;border-radius:12px;font-family:'DM Sans',sans-serif;font-size:1rem;font-weight:500;cursor:pointer;transition:all .3s cubic-bezier(.34,1.56,.64,1)}
  .checkout-btn:hover{background:var(--gold);color:var(--ink);transform:translateY(-2px);box-shadow:0 10px 28px rgba(201,168,76,.3)}

  /* LOADING */
  .page-loading{min-height:60vh;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px;color:var(--muted)}
  .loader{width:40px;height:40px;border-radius:50%;border:3px solid rgba(201,168,76,.2);border-top-color:var(--gold);animation:spin 0.8s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  @media(max-width:900px){
    .product-hero{grid-template-columns:1fr;gap:32px}
    nav,.breadcrumb,.product-hero,.reviews-section,.similar-section{padding-left:20px;padding-right:20px}
    .cart-drawer{width:100%}
  }
</style>
</head>
<body>

<!-- NAV -->
<nav>
  <div class="nav-brand" onclick="go('home.html')">
    <div class="brand-dot"></div>ShopSmart AI
  </div>
  <div>
    <button class="nav-btn ghost" onclick="go('products.html')">Products</button>
    <button class="nav-btn ghost" onclick="openCart()" id="cart-nav-btn">üõç Cart <span id="cart-badge">0</span></button>
    <button class="nav-btn primary" onclick="logout()">Sign out</button>
  </div>
</nav>

<!-- BREADCRUMB -->
<div class="breadcrumb">
  <a href="products.html">Products</a>
  <span>‚Ä∫</span>
  <span id="bc-cat">‚Ä¶</span>
  <span>‚Ä∫</span>
  <span id="bc-name">‚Ä¶</span>
</div>

<!-- MAIN CONTENT -->
<div id="page-content">
  <div class="page-loading">
    <div class="loader"></div>
    <p>Loading product‚Ä¶</p>
  </div>
</div>

<!-- CART OVERLAY -->
<div class="cart-overlay" id="cart-overlay" onclick="closeCart()"></div>
<div class="cart-drawer" id="cart-drawer">
  <div class="cart-head">
    <div class="cart-title">Your Cart</div>
    <button class="cart-close" onclick="closeCart()">‚úï</button>
  </div>
  <div class="cart-items" id="cart-items-list"></div>
  <div class="cart-footer">
    <div class="cart-total">
      <span class="ct-label">Total</span>
      <span class="ct-amount" id="cart-total">‚Çπ0</span>
    </div>
    <button class="checkout-btn" onclick="checkout()">Place Order ‚Üí</button>
  </div>
</div>

<script>
const API   = "https://shopsmart-ai.onrender.com";
const token = localStorage.getItem('token');
const uname = localStorage.getItem('name');

// Get product_id from URL ?id=5
const urlParams = new URLSearchParams(window.location.search);
const PID = parseInt(urlParams.get('id'));

// Cart state
let cart = JSON.parse(localStorage.getItem('cart') || '[]');
let selectedRating = 0;
let wishlist = JSON.parse(localStorage.getItem('wishlist') || '[]');
let PRODUCT = null;

if (!PID) { window.location = 'products.html'; }

// ‚îÄ‚îÄ LOAD PRODUCT ‚îÄ‚îÄ
async function loadProduct() {
  try {
    const res = await fetch(`${API}/api/products/${PID}`);
    if (!res.ok) throw new Error('Not found');
    PRODUCT = await res.json();
    renderProduct(PRODUCT);
    renderReviews(PRODUCT.reviews || []);
    renderSimilar(PRODUCT.similar || []);
  } catch(e) {
    document.getElementById('page-content').innerHTML = `
      <div class="page-loading">
        <div style="font-size:2rem">‚ö†Ô∏è</div>
        <p>Product not found. <a href="products.html" style="color:var(--gold)">Back to products</a></p>
      </div>`;
  }
}

// ‚îÄ‚îÄ RENDER PRODUCT ‚îÄ‚îÄ
function renderProduct(p) {
  const isWished = wishlist.includes(p.product_id);
  const avgRating = p.rating || 0;
  const reviewCount = p.review_count || (p.reviews || []).length;

  document.title = `${p.name} | ShopSmart AI`;
  document.getElementById('bc-cat').textContent  = p.category;
  document.getElementById('bc-name').textContent = p.name;

  document.getElementById('page-content').innerHTML = `
    <div class="product-hero">
      <div class="img-wrap">
        <img src="${p.image_url || p.image || ''}" alt="${p.name}"
          onerror="this.src='';this.style.display='none'">
        ${avgRating >= 4.5 ? '<div class="img-badge">‚≠ê Top Rated</div>' : ''}
      </div>
      <div class="product-info">
        <div class="info-cat">${p.category}</div>
        <h1 class="info-name">${p.name}</h1>

        <div class="rating-row">
          <div class="stars" id="display-stars">${renderStars(avgRating)}</div>
          <span class="rating-num">${avgRating || '‚Äî'}</span>
          <span class="rating-count">(${reviewCount} review${reviewCount !== 1 ? 's' : ''})</span>
        </div>

        <p class="info-desc">${p.description || ''}</p>

        <div class="info-price">
          <span class="currency">‚Çπ</span>${p.price ? Number(p.price).toLocaleString('en-IN') : '‚Äî'}
        </div>

        <div class="info-tags">
          <span class="tag">üì¶ In Stock</span>
          <span class="tag">üöö Free Delivery</span>
          <span class="tag">‚Ü©Ô∏è Easy Returns</span>
        </div>

        <div class="cart-row">
          <div class="qty-wrap">
            <button class="qty-btn" onclick="changeQty(-1)">‚àí</button>
            <span class="qty-num" id="qty-display">1</span>
            <button class="qty-btn" onclick="changeQty(1)">+</button>
          </div>
          <button class="add-cart-btn" id="add-btn" onclick="addToCart()">
            üõç Add to Cart
          </button>
          <button class="wishlist-btn2 ${isWished ? 'saved' : ''}" id="wish-btn"
            onclick="toggleWishlist()">${isWished ? '‚ù§Ô∏è' : 'ü§ç'}</button>
        </div>
        <div class="divider-line"></div>
        <div style="font-size:.82rem;color:var(--muted);line-height:1.8">
          <div>üè∑ Category: <strong style="color:var(--ink)">${p.category}</strong></div>
          <div>‚≠ê Rating: <strong style="color:var(--ink)">${avgRating}/5</strong></div>
        </div>
      </div>
    </div>`;

  updateCartBadge();
}

// ‚îÄ‚îÄ STARS HTML ‚îÄ‚îÄ
function renderStars(rating) {
  let html = '';
  for (let i = 1; i <= 5; i++) {
    if (i <= Math.floor(rating)) html += '<span class="star filled">‚òÖ</span>';
    else if (i - rating < 1 && i - rating > 0) html += '<span class="star half">‚òÖ</span>';
    else html += '<span class="star">‚òÖ</span>';
  }
  return html;
}

// ‚îÄ‚îÄ RENDER REVIEWS ‚îÄ‚îÄ
function renderReviews(reviews) {
  const counts = [0,0,0,0,0];
  reviews.forEach(r => { if(r.rating >= 1 && r.rating <= 5) counts[r.rating-1]++; });
  const total = reviews.length;
  const avg   = total ? (reviews.reduce((s,r) => s+r.rating,0)/total).toFixed(1) : '‚Äî';

  const barsHtml = [5,4,3,2,1].map(n => {
    const pct = total ? Math.round((counts[n-1]/total)*100) : 0;
    return `<div class="bar-row">
      <span class="bar-label">${n}</span>
      <div class="bar-track"><div class="bar-fill" style="width:${pct}%"></div></div>
      <span class="bar-count">${counts[n-1]}</span>
    </div>`;
  }).join('');

  const writeHtml = token ? `
    <div class="write-review">
      <div class="wr-title">Write a Review</div>
      <div class="star-picker" id="star-picker">
        ${[1,2,3,4,5].map(n=>`<span class="star-pick" data-val="${n}" onclick="pickStar(${n})">‚òÖ</span>`).join('')}
      </div>
      <textarea class="review-input" id="review-text" placeholder="Share your experience with this product‚Ä¶"></textarea>
      <button class="submit-review" onclick="submitReview()">Submit Review</button>
      <div class="review-msg" id="review-msg"></div>
    </div>` :
    `<div class="write-review">
      <div class="login-prompt">
        <a onclick="go('index.html')">Sign in</a> to write a review
      </div>
    </div>`;

  const cardsHtml = total ? reviews.map(r => `
    <div class="review-card">
      <div class="rv-head">
        <span class="rv-user">üë§ ${r.user_name}</span>
        <span class="rv-date">${r.date}</span>
      </div>
      <div class="rv-stars">${renderStars(r.rating)}</div>
      <p class="rv-text">${r.text || '<em style="opacity:.5">No comment left.</em>'}</p>
    </div>`).join('') :
    `<div class="no-reviews">No reviews yet ‚Äî be the first! ‚ú¶</div>`;

  const reviewsSection = document.createElement('div');
  reviewsSection.className = 'reviews-section';
  reviewsSection.innerHTML = `
    <div class="section-head">
      <div class="section-title">Customer Reviews</div>
    </div>
    <div class="rating-summary">
      <div class="big-score">
        <div class="big-num">${avg}</div>
        <div class="big-stars">${renderStars(parseFloat(avg)||0)}</div>
        <div class="big-count">${total} review${total!==1?'s':''}</div>
      </div>
      <div class="bars">${barsHtml}</div>
    </div>
    ${writeHtml}
    <div class="reviews-list" id="reviews-list">${cardsHtml}</div>`;

  document.getElementById('page-content').after(reviewsSection);
}

// ‚îÄ‚îÄ RENDER SIMILAR ‚îÄ‚îÄ
function renderSimilar(products) {
  if (!products.length) return;
  const section = document.createElement('div');
  section.className = 'similar-section';
  section.innerHTML = `
    <div class="section-title" style="margin-bottom:0">Similar Products</div>
    <div class="similar-grid">
      ${products.map(p => `
        <div class="sim-card" onclick="go('product.html?id=${p.product_id}')">
          <div class="sim-img">
            <img src="${p.image_url||p.image||''}" alt="${p.name}"
              onerror="this.parentElement.style.background='var(--cream)'">
          </div>
          <div class="sim-body">
            <div class="sim-cat">${p.category}</div>
            <div class="sim-name">${p.name}</div>
            <div class="sim-price">${p.price ? '‚Çπ'+Number(p.price).toLocaleString('en-IN') : ''}</div>
          </div>
        </div>`).join('')}
    </div>`;
  document.querySelector('.reviews-section')?.after(section)
    || document.body.appendChild(section);
}

// ‚îÄ‚îÄ STAR PICKER ‚îÄ‚îÄ
function pickStar(n) {
  selectedRating = n;
  document.querySelectorAll('.star-pick').forEach((s,i) => {
    s.classList.toggle('active', i < n);
  });
}

// ‚îÄ‚îÄ SUBMIT REVIEW ‚îÄ‚îÄ
async function submitReview() {
  const msg  = document.getElementById('review-msg');
  const text = document.getElementById('review-text').value.trim();
  msg.className = 'review-msg';

  if (!selectedRating) {
    msg.textContent = 'Please select a star rating.';
    msg.className = 'review-msg error'; return;
  }
  try {
    const res = await fetch(`${API}/api/products/${PID}/reviews`, {
      method: 'POST',
      headers: { 'Content-Type':'application/json', 'Authorization': `Bearer ${token}` },
      body: JSON.stringify({ rating: selectedRating, text })
    });
    const data = await res.json();
    if (!res.ok) {
      msg.textContent = data.error || 'Could not submit review.';
      msg.className = 'review-msg error';
    } else {
      msg.textContent = '‚úì Review submitted! Thank you.';
      msg.className = 'review-msg success';
      // Reload reviews
      setTimeout(() => loadProduct(), 1000);
    }
  } catch(e) {
    msg.textContent = 'Network error. Try again.';
    msg.className = 'review-msg error';
  }
}

// ‚îÄ‚îÄ QTY ‚îÄ‚îÄ
let qty = 1;
function changeQty(d) {
  qty = Math.max(1, Math.min(10, qty + d));
  document.getElementById('qty-display').textContent = qty;
}

// ‚îÄ‚îÄ CART ‚îÄ‚îÄ
function addToCart() {
  if (!PRODUCT) return;
  const existing = cart.find(i => i.id === PRODUCT.product_id);
  if (existing) { existing.qty = Math.min(existing.qty + qty, 10); }
  else { cart.push({ id: PRODUCT.product_id, name: PRODUCT.name,
    price: PRODUCT.price, image: PRODUCT.image_url || PRODUCT.image, qty }); }
  localStorage.setItem('cart', JSON.stringify(cart));
  const btn = document.getElementById('add-btn');
  btn.textContent = '‚úì Added!'; btn.classList.add('added');
  setTimeout(() => { btn.innerHTML = 'üõç Add to Cart'; btn.classList.remove('added'); }, 1500);
  updateCartBadge();
  renderCartItems();
}

function updateCartBadge() {
  const total = cart.reduce((s,i) => s + i.qty, 0);
  document.getElementById('cart-badge').textContent = total;
}

function openCart()  { document.getElementById('cart-overlay').classList.add('open'); document.getElementById('cart-drawer').classList.add('open'); renderCartItems(); }
function closeCart() { document.getElementById('cart-overlay').classList.remove('open'); document.getElementById('cart-drawer').classList.remove('open'); }

function renderCartItems() {
  const el = document.getElementById('cart-items-list');
  if (!cart.length) {
    el.innerHTML = `<div class="cart-empty"><div class="cart-empty-icon">üõç</div><p>Your cart is empty</p></div>`;
    document.getElementById('cart-total').textContent = '‚Çπ0';
    return;
  }
  el.innerHTML = cart.map((item,i) => `
    <div class="cart-item">
      <div class="ci-img"><img src="${item.image||''}" alt="${item.name}" onerror="this.style.display='none'"></div>
      <div class="ci-info">
        <div class="ci-name">${item.name}</div>
        <div class="ci-price">‚Çπ${Number(item.price||0).toLocaleString('en-IN')}</div>
        <div class="ci-qty">Qty: ${item.qty}</div>
      </div>
      <button class="ci-remove" onclick="removeFromCart(${i})">‚úï</button>
    </div>`).join('');
  const total = cart.reduce((s,i) => s + (i.price||0)*i.qty, 0);
  document.getElementById('cart-total').textContent = '‚Çπ' + total.toLocaleString('en-IN');
}

function removeFromCart(idx) {
  cart.splice(idx, 1);
  localStorage.setItem('cart', JSON.stringify(cart));
  updateCartBadge(); renderCartItems();
}

async function checkout() {
  if (!token) { go('index.html'); return; }
  if (!cart.length) { alert('Your cart is empty!'); return; }
  try {
    const res = await fetch(`${API}/api/orders`, {
      method: 'POST',
      headers: { 'Content-Type':'application/json', 'Authorization': `Bearer ${token}` },
      body: JSON.stringify({ items: cart })
    });
    const data = await res.json();
    if (res.ok) {
      cart = []; localStorage.setItem('cart', JSON.stringify(cart));
      updateCartBadge(); renderCartItems(); closeCart();
      alert(`‚úì Order placed! Order ID: ${data.order_id}\nTotal: ‚Çπ${Number(data.total).toLocaleString('en-IN')}`);
    } else { alert(data.error || 'Order failed'); }
  } catch(e) { alert('Network error'); }
}

// ‚îÄ‚îÄ WISHLIST ‚îÄ‚îÄ
function toggleWishlist() {
  if (!PRODUCT) return;
  const pid = PRODUCT.product_id;
  const idx = wishlist.indexOf(pid);
  if (idx > -1) wishlist.splice(idx, 1); else wishlist.push(pid);
  localStorage.setItem('wishlist', JSON.stringify(wishlist));
  const btn = document.getElementById('wish-btn');
  btn.textContent = wishlist.includes(pid) ? '‚ù§Ô∏è' : 'ü§ç';
  btn.classList.toggle('saved', wishlist.includes(pid));
}

function go(page)  { window.location = page; }
function logout()  { localStorage.clear(); window.location = 'index.html'; }

// ‚îÄ‚îÄ BOOT ‚îÄ‚îÄ
loadProduct();
updateCartBadge();
</script>
</body>
</html>