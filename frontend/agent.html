<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ShopSmart AI Agent</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
  --ink:#0f0e17;--paper:#fffcf5;--gold:#c9a84c;--gold-dim:rgba(201,168,76,.12);
  --cream:#f5f0e8;--muted:#8a8278;--card:#ffffff;--radius:16px;
  --agent-bg:#0f0e17;--agent-text:#fffcf5;
}
html,body{font-family:'DM Sans',sans-serif;background:var(--ink);color:var(--paper);height:100%;overflow:hidden}

/* noise overlay */
body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");pointer-events:none;z-index:999}

/* radial glow */
body::after{content:'';position:fixed;width:600px;height:600px;background:radial-gradient(circle,rgba(201,168,76,.08) 0%,transparent 70%);top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:none;z-index:0}

/* LAYOUT */
.layout{display:grid;grid-template-columns:280px 1fr;height:100vh;position:relative;z-index:1}

/* SIDEBAR */
.sidebar{border-right:1px solid rgba(201,168,76,.1);display:flex;flex-direction:column;padding:28px 20px;background:rgba(255,252,245,.02)}
.brand{display:flex;align-items:center;gap:10px;margin-bottom:32px}
.brand-dot{width:8px;height:8px;background:var(--gold);border-radius:50%;animation:pulse 2s ease-in-out infinite;flex-shrink:0}
@keyframes pulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.5);opacity:.6}}
.brand-name{font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:700}

.sidebar-label{font-size:.68rem;letter-spacing:.18em;text-transform:uppercase;color:rgba(255,252,245,.3);margin-bottom:12px;font-weight:500}

.suggestion-list{display:flex;flex-direction:column;gap:8px;margin-bottom:32px}
.suggestion{padding:11px 14px;border-radius:12px;border:1px solid rgba(201,168,76,.12);background:rgba(201,168,76,.04);font-size:.82rem;color:rgba(255,252,245,.7);cursor:pointer;transition:all .2s ease;line-height:1.4}
.suggestion:hover{border-color:rgba(201,168,76,.4);background:rgba(201,168,76,.1);color:var(--paper);transform:translateX(4px)}
.suggestion .s-icon{font-size:1rem;margin-right:8px}

.sidebar-divider{height:1px;background:rgba(201,168,76,.1);margin:16px 0}

.nav-links{display:flex;flex-direction:column;gap:6px;margin-top:auto}
.nav-link{padding:10px 14px;border-radius:10px;font-size:.85rem;color:rgba(255,252,245,.5);cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:8px;text-decoration:none}
.nav-link:hover{background:rgba(255,252,245,.06);color:var(--paper)}
.clear-btn{padding:10px 14px;border-radius:10px;font-size:.85rem;color:rgba(255,100,100,.6);cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:8px;background:none;border:none;font-family:inherit;width:100%;text-align:left}
.clear-btn:hover{background:rgba(255,100,100,.08);color:rgba(255,100,100,.9)}

/* MAIN CHAT */
.chat-area{display:flex;flex-direction:column;height:100vh}

/* CHAT HEADER */
.chat-header{padding:20px 32px;border-bottom:1px solid rgba(201,168,76,.1);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.agent-info{display:flex;align-items:center;gap:14px}
.agent-avatar{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--gold),#f0d688);display:flex;align-items:center;justify-content:center;font-size:1.1rem;box-shadow:0 0 20px rgba(201,168,76,.3)}
.agent-name{font-family:'Playfair Display',serif;font-size:1rem;font-weight:700}
.agent-status{font-size:.75rem;color:rgba(255,252,245,.4);display:flex;align-items:center;gap:5px;margin-top:2px}
.status-dot{width:6px;height:6px;background:#2ecc71;border-radius:50%;animation:pulse 2s ease-in-out infinite}
.header-actions{display:flex;gap:8px}
.hdr-btn{padding:8px 16px;border-radius:100px;font-family:'DM Sans',sans-serif;font-size:.8rem;font-weight:500;cursor:pointer;transition:all .2s;border:1.5px solid rgba(201,168,76,.2);background:transparent;color:rgba(255,252,245,.6)}
.hdr-btn:hover{border-color:var(--gold);color:var(--paper)}

/* MESSAGES */
.messages{flex:1;overflow-y:auto;padding:28px 32px;display:flex;flex-direction:column;gap:24px;scroll-behavior:smooth}
.messages::-webkit-scrollbar{width:4px}
.messages::-webkit-scrollbar-track{background:transparent}
.messages::-webkit-scrollbar-thumb{background:rgba(201,168,76,.2);border-radius:2px}

/* WELCOME */
.welcome{text-align:center;padding:40px 20px;animation:fadeIn .6s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
.welcome-icon{font-size:3rem;margin-bottom:16px;display:block}
.welcome-title{font-family:'Playfair Display',serif;font-size:1.8rem;font-weight:700;margin-bottom:10px}
.welcome-title em{font-style:italic;color:var(--gold)}
.welcome-sub{font-size:.9rem;color:rgba(255,252,245,.45);font-weight:300;max-width:360px;margin:0 auto;line-height:1.7}

/* MESSAGE BUBBLES */
.msg{display:flex;gap:12px;animation:msgIn .3s ease-out}
@keyframes msgIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.msg.user{flex-direction:row-reverse}
.msg-avatar{width:32px;height:32px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:.85rem;margin-top:4px}
.msg.agent .msg-avatar{background:linear-gradient(135deg,var(--gold),#f0d688)}
.msg.user  .msg-avatar{background:rgba(255,252,245,.1);border:1px solid rgba(201,168,76,.2)}
.msg-body{max-width:70%}
.msg-name{font-size:.72rem;color:rgba(255,252,245,.35);margin-bottom:5px;font-weight:500;letter-spacing:.04em}
.msg.user .msg-name{text-align:right}
.msg-bubble{padding:14px 18px;border-radius:18px;font-size:.9rem;line-height:1.7;font-weight:300}
.msg.agent .msg-bubble{background:rgba(255,252,245,.06);border:1px solid rgba(201,168,76,.1);border-bottom-left-radius:4px;color:rgba(255,252,245,.9)}
.msg.user  .msg-bubble{background:var(--gold);color:var(--ink);font-weight:400;border-bottom-right-radius:4px}

/* PRODUCT CARDS IN CHAT */
.msg-products{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;margin-top:12px;max-width:600px}
.chat-product-card{background:rgba(255,252,245,.05);border:1px solid rgba(201,168,76,.12);border-radius:12px;overflow:hidden;cursor:pointer;transition:all .25s ease}
.chat-product-card:hover{border-color:rgba(201,168,76,.4);background:rgba(201,168,76,.06);transform:translateY(-3px)}
.cp-img{height:100px;overflow:hidden;background:rgba(255,252,245,.03)}
.cp-img img{width:100%;height:100%;object-fit:cover}
.cp-body{padding:10px 12px}
.cp-name{font-size:.78rem;font-weight:500;color:rgba(255,252,245,.9);margin-bottom:3px;line-height:1.3}
.cp-price{font-family:'Playfair Display',serif;font-size:.85rem;font-weight:700;color:var(--gold)}

/* THINKING */
.thinking{display:flex;align-items:center;gap:10px;padding:12px 16px;background:rgba(255,252,245,.04);border:1px solid rgba(201,168,76,.1);border-radius:14px;font-size:.82rem;color:rgba(255,252,245,.4);width:fit-content}
.thinking-dots{display:flex;gap:4px}
.thinking-dots span{width:6px;height:6px;background:var(--gold);border-radius:50%;animation:dotBounce .8s ease-in-out infinite}
.thinking-dots span:nth-child(2){animation-delay:.15s}
.thinking-dots span:nth-child(3){animation-delay:.3s}
@keyframes dotBounce{0%,80%,100%{transform:scale(.6);opacity:.4}40%{transform:scale(1);opacity:1}}

/* TOOL CALL INDICATOR */
.tool-indicator{font-size:.75rem;color:rgba(201,168,76,.6);padding:6px 12px;background:rgba(201,168,76,.06);border-radius:100px;border:1px solid rgba(201,168,76,.12);display:inline-flex;align-items:center;gap:6px;margin-bottom:8px;animation:fadeIn .3s ease}

/* INPUT AREA */
.input-area{padding:20px 32px 28px;flex-shrink:0;border-top:1px solid rgba(201,168,76,.08)}
.input-wrap{display:flex;gap:10px;align-items:flex-end;background:rgba(255,252,245,.05);border:1.5px solid rgba(201,168,76,.15);border-radius:16px;padding:12px 14px;transition:all .2s}
.input-wrap:focus-within{border-color:rgba(201,168,76,.5);background:rgba(255,252,245,.07)}
.chat-input{flex:1;background:none;border:none;outline:none;font-family:'DM Sans',sans-serif;font-size:.92rem;color:var(--paper);resize:none;max-height:120px;min-height:24px;line-height:1.5}
.chat-input::placeholder{color:rgba(255,252,245,.25)}
.send-btn{width:38px;height:38px;border-radius:50%;background:var(--gold);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .25s cubic-bezier(.34,1.56,.64,1);flex-shrink:0}
.send-btn:hover:not(:disabled){transform:scale(1.1);box-shadow:0 6px 20px rgba(201,168,76,.4)}
.send-btn:disabled{opacity:.4;cursor:not-allowed;transform:none}
.send-btn svg{width:16px;height:16px;fill:var(--ink)}
.input-hint{text-align:center;font-size:.72rem;color:rgba(255,252,245,.2);margin-top:10px}

@media(max-width:768px){
  .layout{grid-template-columns:1fr}
  .sidebar{display:none}
  .messages,.input-area,.chat-header{padding-left:16px;padding-right:16px}
  .msg-body{max-width:85%}
}
</style>
</head>
<body>

<div class="layout">
  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="brand">
      <div class="brand-dot"></div>
      <span class="brand-name">ShopSmart AI</span>
    </div>

    <div class="sidebar-label">Try asking</div>
    <div class="suggestion-list">
      <div class="suggestion" onclick="sendSuggestion(this)">
        <span class="s-icon">üéß</span>Best headphones under ‚Çπ5,000?
      </div>
      <div class="suggestion" onclick="sendSuggestion(this)">
        <span class="s-icon">üí™</span>Full home gym setup under ‚Çπ20,000
      </div>
      <div class="suggestion" onclick="sendSuggestion(this)">
        <span class="s-icon">üíª</span>Compare MacBook Air vs Gaming Laptop
      </div>
      <div class="suggestion" onclick="sendSuggestion(this)">
        <span class="s-icon">üéÅ</span>Gift ideas for her under ‚Çπ3,000
      </div>
      <div class="suggestion" onclick="sendSuggestion(this)">
        <span class="s-icon">‚≠ê</span>Top rated products in Sports
      </div>
      <div class="suggestion" onclick="sendSuggestion(this)">
        <span class="s-icon">‚òï</span>Best coffee setup for home
      </div>
    </div>

    <div class="sidebar-divider"></div>

    <div class="nav-links">
      <a class="nav-link" onclick="go('home.html')">üè† Home</a>
      <a class="nav-link" onclick="go('products.html')">üì¶ Products</a>
      <a class="nav-link" onclick="go('recs.html')">‚ú¶ Recommendations</a>
      <div class="sidebar-divider"></div>
      <button class="clear-btn" onclick="clearChat()">üóë Clear conversation</button>
      <a class="nav-link" onclick="logout()" style="color:rgba(255,100,100,.5)">‚Ü© Sign out</a>
    </div>
  </div>

  <!-- CHAT -->
  <div class="chat-area">
    <div class="chat-header">
      <div class="agent-info">
        <div class="agent-avatar">‚ú¶</div>
        <div>
          <div class="agent-name">ShopSmart Agent</div>
          <div class="agent-status">
            <span class="status-dot"></span>
            Online ¬∑ Powered by Claude AI
          </div>
        </div>
      </div>
      <div class="header-actions">
        <button class="hdr-btn" onclick="go('products.html')">Browse Products</button>
      </div>
    </div>

    <div class="messages" id="messages">
      <div class="welcome">
        <span class="welcome-icon">‚ú¶</span>
        <div class="welcome-title">Your <em>AI Shopping</em> Assistant</div>
        <p class="welcome-sub">Ask me anything ‚Äî I can search products, compare options, suggest gifts, or build a complete setup within your budget.</p>
      </div>
    </div>

    <div class="input-area">
      <div class="input-wrap">
        <textarea class="chat-input" id="chat-input" placeholder="Ask me anything‚Ä¶ e.g. 'Best laptop under ‚Çπ60,000'" rows="1"
          onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
        <button class="send-btn" id="send-btn" onclick="sendMessage()">
          <svg viewBox="0 0 24 24"><path d="M22 2L11 13M22 2L15 22l-4-9-9-4 20-7z"/></svg>
        </button>
      </div>
      <div class="input-hint">Powered by Claude AI ¬∑ Your personal shopping expert</div>
    </div>
  </div>
</div>

<script>
const API      = "https://shopsmart-ai.onrender.com";
const token    = localStorage.getItem('token');
const userName = localStorage.getItem('name') || 'You';

// Conversation history for multi-turn context
let conversationHistory = [];
let isThinking = false;

function go(page)   { window.location = page; }
function logout()   { localStorage.clear(); window.location = 'index.html'; }

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
}

function sendSuggestion(el) {
  const text = el.textContent.replace(/^[^\s]+\s/, '').trim();
  document.getElementById('chat-input').value = text;
  sendMessage();
}

function clearChat() {
  conversationHistory = [];
  const msgs = document.getElementById('messages');
  msgs.innerHTML = `<div class="welcome">
    <span class="welcome-icon">‚ú¶</span>
    <div class="welcome-title">Your <em>AI Shopping</em> Assistant</div>
    <p class="welcome-sub">Ask me anything ‚Äî I can search products, compare options, suggest gifts, or build a complete setup within your budget.</p>
  </div>`;
}

function appendMessage(role, text, products) {
  const msgs = document.getElementById('messages');
  // Remove welcome if present
  const welcome = msgs.querySelector('.welcome');
  if (welcome) welcome.remove();

  const isUser  = role === 'user';
  const div     = document.createElement('div');
  div.className = `msg ${isUser ? 'user' : 'agent'}`;

  const productsHtml = (!isUser && products && products.length) ? `
    <div class="msg-products">
      ${products.slice(0,6).map(p => `
        <div class="chat-product-card" onclick="go('product.html?id=${p.product_id}')">
          <div class="cp-img">
            <img src="${p.image_url||''}" alt="${p.name}"
              onerror="this.parentElement.style.background='rgba(201,168,76,.06)'">
          </div>
          <div class="cp-body">
            <div class="cp-name">${p.name}</div>
            <div class="cp-price">${p.price ? '‚Çπ'+Number(p.price).toLocaleString('en-IN') : ''}</div>
          </div>
        </div>`).join('')}
    </div>` : '';

  div.innerHTML = `
    <div class="msg-avatar">${isUser ? 'üë§' : '‚ú¶'}</div>
    <div class="msg-body">
      <div class="msg-name">${isUser ? userName : 'ShopSmart AI'}</div>
      <div class="msg-bubble">${formatText(text)}</div>
      ${productsHtml}
    </div>`;

  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
}

function formatText(text) {
  // Convert markdown-lite to HTML
  return text
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.*?)\*/g,     '<em>$1</em>')
    .replace(/`(.*?)`/g,       '<code style="background:rgba(201,168,76,.1);padding:1px 5px;border-radius:4px;font-size:.85em">$1</code>')
    .replace(/\n/g,            '<br>')
    .replace(/‚Çπ([\d,]+)/g,    '<strong style="color:var(--gold)">‚Çπ$1</strong>');
}

function showThinking() {
  const msgs = document.getElementById('messages');
  const div  = document.createElement('div');
  div.id = 'thinking-indicator';
  div.className = 'msg agent';
  div.innerHTML = `
    <div class="msg-avatar">‚ú¶</div>
    <div class="msg-body">
      <div class="msg-name">ShopSmart AI</div>
      <div class="thinking">
        <div class="thinking-dots"><span></span><span></span><span></span></div>
        <span id="thinking-text">Thinking‚Ä¶</span>
      </div>
    </div>`;
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
}

function updateThinkingText(text) {
  const el = document.getElementById('thinking-text');
  if (el) el.textContent = text;
}

function removeThinking() {
  const el = document.getElementById('thinking-indicator');
  if (el) el.remove();
}

async function sendMessage() {
  const input = document.getElementById('chat-input');
  const text  = input.value.trim();
  if (!text || isThinking) return;

  input.value = '';
  input.style.height = 'auto';
  isThinking = true;
  document.getElementById('send-btn').disabled = true;

  // Add user message
  appendMessage('user', text);
  conversationHistory.push({ role: 'user', content: text });

  showThinking();

  // Cycle thinking messages
  const thinkingMsgs = [
    'Thinking‚Ä¶',
    'Searching products‚Ä¶',
    'Analysing options‚Ä¶',
    'Preparing answer‚Ä¶'
  ];
  let ti = 0;
  const thinkInterval = setInterval(() => {
    ti = (ti + 1) % thinkingMsgs.length;
    updateThinkingText(thinkingMsgs[ti]);
  }, 1800);

  try {
    const res  = await fetch(`${API}/api/agent`, {
      method:  'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({ messages: conversationHistory })
    });

    const data = await res.json();
    clearInterval(thinkInterval);
    removeThinking();

    if (!res.ok) {
      appendMessage('agent', `Sorry, I ran into an issue: ${data.error || 'Unknown error'}. Please try again.`);
    } else {
      const reply = data.reply || "I couldn't find a good answer. Try rephrasing!";
      appendMessage('agent', reply, data.products);
      // Add assistant response to history
      conversationHistory.push({ role: 'assistant', content: reply });
    }
  } catch (e) {
    clearInterval(thinkInterval);
    removeThinking();
    appendMessage('agent', 'Connection error ‚Äî the server may be waking up. Please try again in a moment.');
  }

  isThinking = false;
  document.getElementById('send-btn').disabled = false;
  document.getElementById('chat-input').focus();
}
</script>
</body>
</html>